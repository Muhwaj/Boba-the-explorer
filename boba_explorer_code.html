<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device width, initial scale =1.0">
    <title>Bobba The Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Trebuchet MS', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height:100vh;
            /* */
        }

        #gameContainer {
            background: #f5f0e8;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 1200px;
            height: 800 px;
            position: relative;
            /*  */
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            background: white; /*  */
        }

        .game-over { /*  */
            position: absolute;
            top: 50%;
            left: 50%;
            background: beige;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .game-over h2 {
            font-size: 48px;
            color: #667eea;
            /*  */
        }

        .game-over button {
            background: #667eea;
            color: beige;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 10px;
            cursor: pointer; 
            /*  */
        }

        .game-over button:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id=" gameCanvas" width="1200" height="800"></canvas>
        <div class="game-over" id="gameOver">
            <h2>Level Completed!</h2>
            <p id="LevelStats"></p>
            <button onclick="game.nextLevel()">Next Level</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementByID("gameCanvas");
        const ctx = canvas.getContext("2d");

        class Ingredient {
            constructor(name, category, colour, cost) {
                this.name = name;
                this.category = category;
                this.colour = colour;
                this.cost = cost;
            }
        }
        
        class DrinkRecipe {
            constructor (name, type, baseReward, ingredients) {
                this.name = name;
                this.type = type; /* milkshake or boba */
                this.baseReward = baseReward;
                this.ingredients = ingredients;
            }

        }

        class Customer {
            constructor (isAlien, order, x, y) {
                this.isAlien = isAlien;
                this.order = order;
                this.x = x;
                this.y = y;
                this.patience = 60; //in seconds
                this.maxpatience = 60;
                this.bubbleGreen = 0; // from 0 to 1
                this.glitchTimer = 0;
                this.gltiching = false;
            }

            update(dt) {
                this.patience -= dt;

                if(this.isAlien) {
                    this.glitchTimer += dt;
                    this.glitching = Math.sin(this.glitchTimer*8) > 0.7;
                    this.bubbleGreen = Math.min(1, this.bubbleGreen + dt * 0.12); 
                }
            }

            draw(ctx){
                //CUSTOMER SPRITE [YET TO DRAW]
                //CUSTOMER ALIEN SPRITE [YET TO DRAW]

                //DRAW Order Bubble [YET TO DRAW]
                this.drawOrderBubble(ctx);

                //DRAW patience Bar [YET TO DRAW]
                this.PatienceBar(ctx);
            }

            drawOrderBubble(ctx) {
                const bubbleX = this.x;
                const bubbleY = this.y - 80;
                const bubbleWidth = 160;
                const bubbleHeight = 90;

                ctx.save();

                // Bubble color transitions to green for alien customers
                if (this.isAlien) {
                    const greenAmount = Math.floor(this.bubbleGreen * 200);
                    ctx.fillStyle = `rgb(${255 - greenAmount}, 255, ${255 - greenAmount})`;
                } else {
                    ctx.fillStyle = '#fff';
                }

                // Bubble
                ctx.beginPath();
                ctx.roundRect(bubbleX - bubbleWidth/2, bubbleY, bubbleWidth, bubbleHeight, 10);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Order text
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(this.order.name, bubbleX, bubbleY + 20);
                
                // Ingredients
                ctx.font = '12px Arial, Helvetica, sans-serif;';
                ctx.textAlign = 'left';
                let yOffset = 40;
                this.order.ingredients.forEach(ing => {
                    ctx.fillText(`â€¢ ${ing}`, bubbleX - bubbleWidth/2 + 10, bubbleY + yOffset);
                    yOffset += 18;
                });
                
                ctx.restore();
            }

            PatienceBar(ctx) {
                const barWidth = 70;
                const barHeight = 8;
                const barX = this.x - barWidth / 2;
                const barY = this.y + 50;
                
                // Background
                ctx.fillStyle = '#ccc';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                // Patience fill
                const fillWidth = barWidth * (this.patience / this.maxPatience);
                if (this.patience > 30) {
                    ctx.fillStyle = '#00ff00';
                } else if (this.patience > 15) {
                    ctx.fillStyle = '#ffff00';
                } else {
                    ctx.fillStyle = '#ff0000';
                }
                ctx.fillRect(barX, barY, fillWidth, barHeight);
                
                // Border
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(barX, barY, barWidth, barHeight);

            }    
        }


        class BobbaGame {
            constructor() {
                this.level = 1;
                this.coins = 10;
                this.score = 0;
                this.customersToServe = 5;
                this.customersServed = 0;

                this.sprites = {
                    // Customer sprites (normal and alien versions)
                    customerNormal: null,  
                    customerAlien: null,   
                    
                    // Glass selection buttons
                    milkshakeGlassButton: null,  
                    bobaGlassButton: null,       

                    // Current drink displayed (on the right)
                    milkshakeGlass: null,  
                    bobaGlass: null,       

                    // Paralysis drop
                    paralysisDrop: null,  
                    
                    // Milkshake flavors
                    milkshakeFlavors: {
                        chocolate: null,   
                        vanilla: null,     
                        mango: null,      
                        strawberry: null,  
                    },
                    
                    // Milkshake toppings
                    milkshakeToppings: {
                        fruit: null,          
                        whippedCream: null,   
                        straw: null,          
                    },
                    
                    // Boba flavors
                    bobaFlavors: {
                        brownSugar: null,   
                        tea: null,          
                        chocolate: null,    
                        strawberry: null, 
                        taro: null,         
                    },
                    
                    // Boba pearls
                    bobaPearls: {
                        bobaPearls: null,    
                        poppingBoba: null,   
                    },
                    
                    // Boba toppings
                    bobaToppings: {
                        coconutJelly: null,  
                    }
                };
                
                // Ingredients for MILKSHAKES
                this.milkshakeIngredients = {
                    flavor: [
                        new Ingredient('Chocolate', 'flavor', '#654321', 2),
                        new Ingredient('Vanilla', 'flavor', '#fff5cc', 2),
                        new Ingredient('Mango', 'flavor', '#ffdc00', 3),
                        new Ingredient('Strawberry', 'flavor', '#ff69b4', 2),
                    ],
                    topping: [
                        new Ingredient('Fruit', 'topping', '#ff6347', 1),
                        new Ingredient('Whipped Cream', 'topping', '#fff', 1),
                        new Ingredient('Straw', 'topping', '#ffff00', 0),
                    ]
                };
                
                // Ingredients for BOBA
                this.bobaIngredients = {
                    flavor: [
                        new Ingredient('Brown Sugar', 'flavor', '#8B4513', 2),
                        new Ingredient('Tea', 'flavor', '#90c090', 2),
                        new Ingredient('Chocolate', 'flavor', '#654321', 2),
                        new Ingredient('Strawberry', 'flavor', '#ff69b4', 2),
                        new Ingredient('Taro', 'flavor', '#c89fd0', 3),
                    ],
                    pearls: [
                        new Ingredient('Boba Pearls', 'pearls', '#000', 2),
                        new Ingredient('Popping Boba', 'pearls', '#ff69b4', 2),
                    ],
                    topping: [
                        new Ingredient('Coconut Jelly', 'topping', '#f5f5dc', 1),
                    ]
                };

                // Paralysis drop 
                this.paralysisIngredient = new Ingredient('Paralysis Drop', 'special', '#045e04', 0);
                
                // Recipes - Milkshakes
                this.milkshakeRecipes = [
                    new DrinkRecipe('Chocolate Shake', 'milkshake', ['Chocolate', 'Whipped Cream', 'Straw'], 30),
                    new DrinkRecipe('Vanilla Shake', 'milkshake', ['Vanilla', 'Whipped Cream', 'Straw'], 30),
                    new DrinkRecipe('Mango Shake', 'milkshake', ['Mango', 'Whipper Cream', 'Straw'], 35),
                    new DrinkRecipe('Strawberry Shake', 'milkshake', ['Strawberry', 'Whipped Cream', 'Fruit'], 30),
                ];

                // Recipes - Boba
                this.bobaRecipes = [
                    new DrinkRecipe('Brown Sugar Boba', 'boba', ['Brown Sugar', 'Boba Pearls'], 35),
                    new DrinkRecipe('Green Tea Boba', 'boba', ['Green Tea', 'Popping Boba', 'Coconut Jelly'], 35),
                    new DrinkRecipe('Chocolate Boba', 'boba', ['Chocolate', 'Boba Pearls'], 35),
                    new DrinkRecipe('Strawberry Boba', 'boba', ['Strawberry', 'Popping Boba', 'Coconut Jelly'], 35),
                    new DrinkRecipe('Taro Boba', 'boba', ['Taro', 'Boba Pearls'], 40),
                ];

                this.allRecipes = [...this.milkshakeRecipes, ...this.bobaRecipes];

                // Game state
                this.currentSection = null; // 'milkshake' or 'boba' or null (not selected yet)
                this.currentDrink = [];
                this.drinkHasParalysis = false;
                this.customerQueue = [];
                this.selectedCategory = null;
                this.message = '';
                this.messageTimer = 0;
                this.alienRevealCooldown = 0; // Cooldown timer for when alien is revealed

                // User interface buttons
                this.buttons = {};
                
                // Initialise
                this.generateInitialCustomers();
                this.lastTime = Date.now();
                
                // Starting game loop
                this.gameLoop();
                
                // Mouse handling
                canvas.addEventListener('click', (e) => this.handleClick(e));
            }

            generateCustomer (position) {
                const isAlien = Math.random () < 0.25;
                const order = this.allRecipes[Math.floor(Math.random() * this.allRecipes.length)];

                const x = 100 + position * 200;
                const y = 150;

                return new Customer(isAlien, x, y);

            }

            generateInitialCustomers() {
                const num = Math.min(3, this.customersToServe - this.customersServed);
                for (let i = 0; i <num; i++) {
                    this.customerQueue.push(this.generateCustomer(i));
                }    
            }

            addIngredient(ingredient) {
                //Checking if glass type [boba cup OR milkshake glass] is selected first
                if (!this.currentSection) {
                    this.showMessage('Please selecte a glass first! (boba cup or milkshake glass)', 2);
                    return;
                }

                                
                if (ingredient.name === 'Paralysis Drop') {
                    this.drinkHasParalysis = true;
                    this.showMessage('Paralysis Drop Added!', 2);
                } else {
                    this.currentDrink.push(ingredient.name);
                    this.showMessage(`Added ${ingredient.name}`, 1);
                }
            }

            clearDrink() {
                this.currentDrink = [];
                this.drinkHasParalysis = false;
                this.currentSection = null; // resets glass selection as well
                this.showMessage('Drink cleared! Select glass.', 1);
            }

            serveDrink() {
                if (this.customerQueue.length === 0) return;
                
                // Checks if glass type is selected
                if (!this.currentSection) {
                    this.showMessage('Please select a glass first!', 2);
                    return;
                }

                if (this.currentDrink.length === 0 && !this.drinkHasParalysis) {
                    this.showMessage('No drink to serve!', 2);
                    return;
                }

                //Check with which customer drink matches
                let matchedCustomer = null;

                 for (let customer of this.customerQueue) {
                    // Checks if drink has exactly the same ingredients (order doesn't matter)
                    const drinkSorted = this.currentDrink.slice().sort();
                    const orderSorted = customer.order.ingredients.slice().sort();
                    
                    const exactMatch = drinkSorted.length === orderSorted.length &&
                        drinkSorted.every((ing, idx) => ing === orderSorted[idx]);
                    
                    if (exactMatch) {
                        matchedCustomer = customer;
                        break;
                    }
                }

                if (!matchedCustomer) {
                    this.showMessage ('Drink doesn\'t match any order' , 2);
                    return;
                }

                const customer = matchedCustomer;

                //Calculate complexity of drink bonus 
                const complexityBonus = this.currentDrink.reduce((sum, name) => {
                    const allIngredients = [
                        ...this.milkshakeIngredients.flavor,
                        ...this.milkshakeIngredients.topping,
                        ...this.bobaIngredients.flavor,
                        ...this.bobaIngredients.pearls,
                        ...this.bobaIngredients.topping
                    ];
                    const ing = allIngredients.find(i => i.name === name);
                    return ing ? sum + ing.cost : sum;
                }, 0);

                //for correct alien paralysis. Drink must be correctly made AND include the paralysis drop
                const isParalysisDrink = this.drinkHasParalysis;

                if (customer.isAlien && isParalysisDrink) {
                    // SUCCESS: Caught alien with correct drink + paralysis
                    const reward = customer.order.baseReward + complexityBonus + 20;
                    this.coins += reward;
                    this.score += 100;
                    this.showMessage(`AN ALIEN CAUGHT! +${reward} coins!`, 2.5);
                    this.removeCustomer(customer);

                } else if (customer.isAlien && !isParalysisDrink) {
                    // FAILURE: Alien escapes and all customers run away
                    this.showMessage('ALIEN REVEALED! All customers flee!', 4);
                    this.customerQueue = [];
                    this.coins = Math.max(0, this.coins - 50);
                    this.score = Math.max(0, this.score - 100);
                    
                    // Start 5 second cooldown before new customers appear
                    this.alienRevealCooldown = 5.0;
                    
                    // Clear drink
                    this.currentDrink = [];
                    this.drinkHasParalysis = false;
                    this.currentSection = null;

                    //wait for cool down to finish
                    return;

                } else if (!customer.isAlien && isParalysisDrink ) {
                    //LOUD INCORRECT BUZZER. Customer leaves
                    this.showMessage('CUSTOMER LEAVES', 2.5)
                    this.coins = Math.max(0, this.coins - 10);
                    this.removeCustomer(customer);

                } else {
                    //Correct order for normal customer
                    const patienceBonus = Math.floor(10 * (customer.patience / customer.maxPatience));
                    const reward = customer.order.baseReward + complexityBonus + patienceBonus;
                    this.coins += reward;
                    this.score += 50;
                    this.showMessage(`Perfect! +${reward} coins!`, 2);
                    this.removeCustomer(customer);

                }

                // Clear drink
                this.currentDrink = [];
                this.drinkHasParalysis = false;
                this.currentSection = null; // Reset glass selection after serving
                
                // Don't add new customers yet 
                if (this.alienRevealCooldown > 0) {
                    return;
                }
                
                // Add new customer 
                if (this.customersServed < this.customersToServe && this.customerQueue.length < 3) {
                    this.customerQueue.push(this.generateCustomer(this.customerQueue.length));
                }
            }

             removeCustomer(customer) {
                const index = this.customerQueue.indexOf(customer);
                if (index > -1) {
                    this.customerQueue.splice(index, 1);
                    this.customersServed++;
                    this.repositionCustomers();
                }
            }

            repositionCustomers() {
                this.customerQueue.forEach((customer, i) => {
                    customer.x = 100 + i * 200;
                });
            }

            showMessage(text, duration) {
                this.message = text;
                this.messageTimer = duration;
            }

            arraysEqual(a, b) {
                if (a.length !== b.length) return false;
                for (let i = 0; i < a.length; i++) {
                    if (a[i] !== b[i]) return false;
                }
                return true;
            }

            update(dt) {
                // Update the message timer
                if (this.messageTimer > 0) {
                    this.messageTimer -= dt;
                    if (this.messageTimer <= 0) {
                        this.message = '';
                    }
                }
                
                // Update the alien reveal cooldown
                if (this.alienRevealCooldown > 0) {
                    this.alienRevealCooldown -= dt;
                    
                    // When cooldown ends generate more customers 
                    if (this.alienRevealCooldown <= 0 && this.customerQueue.length === 0) {
                        const remaining = this.customersToServe - this.customersServed;
                        for (let i = 0; i < Math.min(3, remaining); i++) {
                            this.customerQueue.push(this.generateCustomer(i));
                        }
                        this.showMessage('New customers arriving...', 2);
                    }
                    return; // Don't update the customers during cooldown
                }
                
                // Update the customers
                for (let i = this.customerQueue.length - 1; i >= 0; i--) {
                    const customer = this.customerQueue[i];
                    customer.update(dt);
                    
                    // Remove customers if they run out of patience
                    if (customer.patience <= 0) {
                        this.showMessage('Customer left! Out of patience.', 2);
                        this.customerQueue.splice(i, 1);
                        this.customersServed++;
                        this.coins = Math.max(0, this.coins - 15);
                        this.repositionCustomers();
                        
                        // Add more customers
                        if (this.customersServed < this.customersToServe && this.customerQueue.length < 3) {
                            this.customerQueue.push(this.generateCustomer(this.customerQueue.length));
                        }
                    }
                }
                
                // Check if level complete
                if (this.customersServed >= this.customersToServe) {
                    this.levelComplete();
                }
            }

            levelComplete() {
                document.getElementById('levelStats').innerHTML = `
                    <p style="font-size: 24px; margin: 20px 0;">Level ${this.level} Complete!</p>
                    <p>Coins Earned: ${this.coins}</p>
                    <p>Total Score: ${this.score}</p>
                `;
                document.getElementById('gameOver').style.display = 'block';
            }

            nextLevel() {
                document.getElementById('gameOver').style.display = 'none';
                this.level++;
                this.customersToServe += 2;
                this.customersServed = 0;
                this.customerQueue = [];
                this.currentDrink = [];
                this.drinkHasParalysis = false;
                this.currentSection = null; // Reset glass selection for the next level 
                this.generateInitialCustomers();
                this.showMessage(`Level ${this.level}! Serve ${this.customersToServe} customers!`, 3);
            }

            draw() {
                // Clear the canvas
                ctx.fillStyle = '#f5f0e8';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Need to draw customers [DRAW]
                this.customerQueue.forEach(customer => customer.draw(ctx));
                
                // Need to draw UI [DRAWWWW]
                this.drawStats();
                this.drawSections();
                this.drawDrinkStation();
                this.drawMessage();
            }

            drawStats() {
                ctx.fillStyle = '#000';
                ctx.font = 'Trebuchet MS', 'sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`Level: ${this.level}`, 20, 35);
                
                ctx.fillStyle = '#ffd700';
                ctx.fillText(`ðŸ’° Coins: ${this.coins}`, 180, 35);
                
                ctx.fillStyle = '#000';
                ctx.fillText(`Score: ${this.score}`, 420, 35);
                
                ctx.font = '18px Trebuchet MS', 'sans-serif';
                ctx.fillText(`Customers: ${this.customersServed}/${this.customersToServe}`, 20, 65);
            }

            drawSections() {
                const sectionY = 250;
                const sectionHeight = 520; 
                
                // Milkshake Section
                const milkshakeX = 50;
                const milkshakeW = 320;
                
                ctx.fillStyle = '#ffd4e5';
                ctx.beginPath();
                ctx.roundRect(milkshakeX, sectionY, milkshakeW, sectionHeight, 15);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Title with button
                ctx.fillStyle = '#000';
                ctx.font = 'bold 24px Comic Sans MS';
                ctx.textAlign = 'left';
                ctx.fillText('ðŸ¥¤ MILKSHAKE', milkshakeX + 20, sectionY + 35);
                
                
                // MILKSHAKE GLASS BUTTON SPRITE
                
                const milkshakeBtn = {x: milkshakeX + 240, y: sectionY + 15, w: 60, h: 35};
                this.buttons.select_milkshake = milkshakeBtn;
                
                // PEPLACE WITH MILKSHAKE SPRITES
                
                
                // Current placeholder FOR NOW (REPLACE THIS):
                ctx.fillStyle = this.currentSection === 'milkshake' ? '#ff69b4' : '#fff';
                ctx.beginPath();
                ctx.roundRect(milkshakeBtn.x, milkshakeBtn.y, milkshakeBtn.w, milkshakeBtn.h, 5);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Comic Sans MS';
                ctx.textAlign = 'center';
                ctx.fillText('SELECT', milkshakeBtn.x + milkshakeBtn.w/2, milkshakeBtn.y + 22);
            
            
                
                
                // Need to Draw ingredients [milkshake âœ… still need to draw boba]
                this.drawSectionIngredients(milkshakeX, sectionY + 70, milkshakeW, this.milkshakeIngredients, 'milkshake');
                
            
                // PARALYSIS DROP SPRITE [REPLACE WITH DRAWING]
                
                const paraX = 390;
                const paraY = sectionY + sectionHeight/2 - 60;
                const paraW = 100;
                const paraH = 120;
                
                // PLACEHOLDER: Replace WITH SPRITE
                
                
                //  (REPLACE THIS):
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.roundRect(paraX, paraY, paraW, paraH, 10);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                












        
